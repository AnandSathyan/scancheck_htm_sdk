<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RS232 Barcode Scanner</title>
</head>
<body>

    <h1>RS232 Barcode Scanner</h1>
    <button id="connectButton">Connect to Scanner</button>
    <p id="status">Status: Not connected</p>
    <h3>Scanned Barcode:</h3>
    <p><strong id="barcode">None</strong></p> <!-- This will display the scanned barcode -->

    <script>
        let port;
        let reader;
        let decoder;
        let decoderStream;
        const statusElement = document.getElementById("status");
        const barcodeElement = document.getElementById("barcode");

        // Connect to the serial port
        document.getElementById('connectButton').addEventListener('click', async () => {
            try {
                // Request the user to connect to the serial port
                port = await navigator.serial.requestPort();
                await port.open({ baudRate: 9600 });  // Open the port at 9600 baud rate

                statusElement.textContent = 'Status: Connected';

                // Create a reader for the port
                reader = port.readable.getReader();

                // Use a text decoder to convert bytes to a string
                decoder = new TextDecoder();
                decoderStream = new ReadableStream({
                    start(controller) {
                        function read() {
                            reader.read().then(({ done, value }) => {
                                if (done) {
                                    controller.close();
                                    return;
                                }
                                const text = decoder.decode(value, { stream: true });
                                controller.enqueue(text);
                                read();
                            });
                        }
                        read();
                    }
                });

                // Start reading from the serial port
                const readableStreamClosed = port.readable.pipeTo(decoderStream);
                const readerStream = decoderStream.getReader();
                readerStream.read().then(function processText({ done, value }) {
                    if (!done) {
                        barcodeElement.textContent = value;  // Display scanned barcode value
                        readerStream.read().then(processText);
                    }
                });
            } catch (err) {
                statusElement.textContent = 'Status: Error - ' + err;
            }
        });

        // Disconnect the serial port when done
        async function disconnect() {
            if (reader) {
                reader.cancel();
            }
            if (port) {
                await port.close();
            }
            statusElement.textContent = 'Status: Disconnected';
        }
    </script>

</body>
</html>
